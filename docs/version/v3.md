# NiceGUI V3 更新说明

原文链接: [https://github.com/zauberzeug/nicegui/pull/5109](https://github.com/zauberzeug/nicegui/pull/5109)

## 新功能和增强功能
* 引入 NiceGUI 脚本模式以取代笨拙的自动索引页面（通过 ui.run 中的位置根参数，放弃自动索引页面，转而使用简化的 SPA，由 @rodja、@falkoschindler 提交 #5005）
* 为 ui.run 引入根页面参数以简化单页应用程序（简化单页应用程序 (SPA) 的设置 #4964，通过 ui.run 中的位置根参数，放弃自动索引页面，转而使用简化的 SPA，由 @rodja、@falkoschindler 提交 #5005）
* 引入事件系统以在 UI 和长生命周期对象之间进行通信（引入事件类用于在代码不同部分之间发送事件，由 @falkoschindler、@denniswittich 提交 #5107）
* 通过使用 runpy 加载主文件来简化 pytest（Pytest 可以使用 runpy 加载主文件，由 @rodja、@falkoschindler 提交 #5102）
* 使 props、classes 和 style 可观察以自动发送更新（使 props、classes 和 style 可观察以自动发送更新，由 @lawrenceakka、@falkoschindler、@rodja 提交 #4978）
* 升级到 Tailwind 4（升级到 Tailwind 4，由 @falkoschindler 提交 #5057）
* 放弃对 Python 3.8 的支持（切换到 python 3.9，由 @Solipsistmonkey、@falkoschindler 提交 #4329）
* 引入 ValueChangeEventArguments.previous_value（元素的先前值 #4410，引入 ValueChangeEventArguments.previous_value，由 @me21、@falkoschindler、@evnchn 提交 #4456）
* 为绑定方法引入严格选项（为绑定添加一个选项以检查目标是否存在，由 @denniswittich、@codingpaula、@falkoschindler 提交 #5040）
* 为 ui.html 和 ui.chat_message 引入 sanitize 参数（为 ui.html 引入新的 sanitize 参数，由 @oxqnd、@falkoschindler、@rodja、@evnchn 提交 #5187）
* 改进对从右到左书写语言的支持（Quasar 的 RTL 支持 #5045，改进对从右到左书写语言的支持，由 @M6stafa、@falkoschindler 提交 #5058）
* 对 ui.log 使用 q-scroll_area 以保持固定高度（ui.log 在推送行时不应增长 #4925，对 ui.log 使用 q-scroll_area 以保持固定高度，由 @e-nesse、@falkoschindler 提交 #4935）
* 如果剪贴板 API 不可用，让 ui.clipboard.read() 返回 None（如何确定当前连接是否安全 #4236，如果剪贴板 API 不可用，ui.clipboard 应返回 None，由 @weinibuliu、@falkoschindler、@evnchn 提交 #4237）
* 更一致地调用生命周期事件处理程序（更一致地调用生命周期事件处理程序，由 @falkoschindler、@evnchn、@rodja 提交 #5173）
* 改进 UploadEventArguments 和 MultiUploadEventArguments 以避免未关闭的资源（新的上传 api，由 @rodja、@evnchn、@falkoschindler 提交 #5178）
* 如果进程池因错误的 run.cpu_bound 而损坏，则重新初始化进程池（如果进程意外终止，run.cpu_bound 上的进程池会损坏 #4980，如果进程池因错误的 run.cpu_bound 而损坏，则重新初始化 process_pool，由 @jammerhund、@evnchn、@rodja、@falkoschindler 提交 #5129）
* 删除已弃用的代码和 API（删除已弃用的代码和 API，由 @falkoschindler 提交 #5037）
* 将 pytest 警告视为错误（在 3.9 的拆卸阶段持久化失败 #5182，将 pytest 警告视为错误，由 @evnchn、@rodja、@falkoschindler 提交 #5186）

## ⚠️ 重大更改和迁移指南

### 1. 共享自动索引页面（不使用 `@ui.page`）

在全局范围内定义的 UI 元素已添加到在“/”处提供的静态共享“自动索引客户端”。 这在整个代码库中引起了许多问题，因此我们决定删除此共享客户端。

在 3.0 版中，您有以下选择：

*   继续将（所有）UI 元素放在全局范围内。 我们将这种没有页面函数的应用程序称为“NiceGUI 脚本”。 当访问“/”时，它们将在隐式页面函数内自动重新评估。 这几乎是自动索引客户端的直接替代品，但是：
    *   NiceGUI 脚本不能包含页面函数。
    *   UI 不共享，但在每次页面访问时重新创建。
*   将所有 UI 包装在一个函数中，并将其传递给 `ui.run` 中新的位置根参数。 这在与 ui.sub_pages 结合使用时特别方便。 这样，您就可以创建丰富的单页应用程序，而不必担心使用 @page 装饰器定义正确的路由。

*   为您所有的页面使用页面函数，包括“/”处的索引页面。

请注意，我们正在引入一个新的 Event 类。 它与绑定模块一起，有助于同步长生命周期对象和短生命周期 UI，而无需依赖长生命周期的共享客户端。

### 2. 调用带后续 .update() 的 .props()、.classes() 或 .style()

不再需要后续的 .update()，因为 props、classes 和 style 现在是可观察的集合，可以自动触发更新。

在自定义元素中覆盖 update 方法时，可能会发生无限递归。 例如，如果 update 方法在调用 super().update() 之前使用 .prop()，则 .prop() 调用将导致无限循环。 使用 with self._props.suspend_updates():（以及类似的 classes 和 style）包装它以在这种情况下暂停自动更新。

### 3. 升级到 Tailwind 4；放弃 ui.element.tailwind API

虽然非常相似，但 Tailwind 4 带来了一些重大更改。 升级后请仔细检查您的布局。 我们注意到特别是在行间距和边框方面存在差异。

由于技术原因，更新和维护我们的 ui.element.tailwind API 变得不可行。 因此我们决定将其删除。 对于自动完成 Tailwind 类，我们推荐由 @DaelonSuzuka 开发的 Visual Studio Code 的 NiceGUI 扩展。

### 4. 放弃对 Python 3.8 的支持

在 Python 3.8 达到其生命周期结束将近一年后，是时候放弃对它的支持了。 这使我们能够将代码更新到更新的标准，并解决一些 Python 依赖项的问题，这些依赖项在不久前已经放弃了 3.8。

> NiceGUI 3.0 开始要求最低版本为 Python 3.9 ，译者注

### 5. ValueChangeEventArguments 获得了一个新的 previous_value 属性

在某些情况下，同时访问当前值和先前值可能会有所帮助。 因此，我们将 previous_value 添加到 ValueChangeEventArguments 中。

发出 ValueChangeEventArguments 的自定义元素需要提供先前的值。

### 6. 从不存在的对象属性进行绑定和绑定到不存在的对象属性

如果其中一个属性不存在，绑定过去会静默失败。 对于字典，这是有意的，因为它们通常用于绑定到默认为空的持久存储。 但是对于对象属性，这可能会导致非常细微的错误，例如在重命名属性并且没有更新绑定函数中的属性名称之后。

在 3.0 中，默认情况下将检查对象属性是否存在。 缺少的字典将继续被忽略。

您可以使用 strict: bool | None = None 参数（None：检查对象属性并忽略字典）来微调此行为。

### 7. 为 ui.html 和 ui.chat_message 清理内容

为了防止 NiceGUI 应用程序意外地将不安全的用户输入显示为 HTML，ui.html 和 ui.chat_message 现在有一个 sanitize 参数。 它可以设置为像来自 html-sanitizer 模块的 Sanitizer().sanitize 这样的函数，或者设置为 False 以禁用清理。 虽然 ui.html 要求指定新参数，但 ui.chat_message 仅在 text_html=True 时才需要它。

请注意，html-sanitizer 模块不包含在 NiceGUI 中，如果需要，需要单独安装。

### 8. 未指定宽度的 ui.log 可能会在未指定宽度的容器内折叠

我们注意到 ui.log 的高度可能会受到其内容的影响，这是出乎意料的。 因此，我们决定使用滚动区域以获得更健壮的布局。

现在，当放置在未指定宽度的容器内时，ui.log 的宽度可能会折叠。 要么给容器一些宽度，要么指定 ui.log 的宽度。

### 9. 如果剪贴板 API 不可用，ui.clipboard.read() 返回 None

如果剪贴板 API 不可用，read() 函数过去会返回一个空字符串。 这与空剪贴板无法区分。

现在，如果剪贴板 API 不可用，read() 函数将返回 None。

### 10. 生命周期事件被更一致地调用

使用 on_disconnect 注册的处理程序过去仅在客户端无法重新连接并被删除后才被调用。

现在，当连接丢失时，会立即调用断开连接处理程序，即使客户端在短暂的时间后重新连接。

可以使用新的 on_delete 函数来注册用于删除客户端的回调。

### 11. UploadEventArguments 和 MultiUploadEventArguments 已更改

事件参数现在包含一个单独的字段 file: FileUpload，而不是 content: BinaryIO、name: str 和 type: str，该字段包含

*   属性 name: str 和 content_type: str 以及
*   方法 read、text、json、iterate、save 和 size 以访问内容。

### 12. 删除已弃用的代码和 API

*   app.add_static_file 和 app.add_media_file 在文件不存在的情况下会引发 FileNotFoundError 而不是 ValueError。 由于 FileNotFoundError 不是 ValueError 的子类，因此捕获 ValueError 的现有代码将无法捕获新的 FileNotFoundError。
*   ui.aggrid：run_column_method 已被删除。 请改用 run_grid_method。
*   ui.table 调用 add_rows()/remove_rows() 时使用可变长度参数不再起作用。 请传递一个列表，或对单行使用 add_row()/remove_row()。
*   ui.open 已被删除。 请改用 ui.navigate.to。
*   nicegui.testing.conftest 已被删除，您不能再导入它。 请改用 pytest_plugins = ["nicegui.testing.plugin"]。
*   element.on 参数 js_handler 现在具有类型 str 而不是 str | None。 您可以传递一个 None，它仍然有效，但您的类型检查器不会满意，我们不能保证它在之后还能工作很长时间。

## JavaScript 依赖项
管理节点包的基础设施已得到显着改善（#4163、#5021 由 @simontaurus、@evnchn、@falkoschindler 提交）。
以下 JavaScript 依赖项已更新到最新版本（#5034、#5168、#5190 由 @falkoschindler 提交）：

* @tailwindcss/browser: 3.4.10 → 4.1.13 (升级到 Tailwind 4 #5057 由 @falkoschindler)
* es-module-shims: 1.10.0 → 2.6.2
* quasar: 2.16.9 → 2.18.5 (解决客户端内存泄漏 #4892 由 @eddie3ruff、@evnchn、@xaptronic、@falkoschindler)
* socket.io: 4.7.5 → 4.8.1
* vue: 3.4.28 → 3.5.22
* ag-grid-community: 32.1.0 → 34.2.0 (解决 AG-Grid 的 'rowSelection': {'mode':"multiRow",'headerCheckbox':False} 不起作用 #3854 由 @python-and-novella、@mockey、@falkoschindler)
* codemirror: 6.0.1 → 6.0.2
* @codemirror/language-data: 6.5.1 (new)
* @codemirror/theme-one-dark: 6.1.3 (new)
* @uiw/codemirror-themes-all: 4.25.2 (new)
* @babel/runtime: 7.28.4 (new)
* echarts: 5.5.1 → 6.0.0
* echarts-gl: 2.0.9 (unchanged)
* nipplejs: 0.10.2 (unchanged)
* vanilla-jsoneditor: 0.23.8 → 3.10.0
* leaflet: 1.9.4 (unchanged)
* leaflet-draw: 1.0.4 (unchanged)
* mermaid: 11.0.2 → 11.12.0
* plotly.js: 2.35.0 → 3.1.1
* three: 0.168.0 → 0.180.1
* @tweenjs/tween.js: 25.0.0 (unchanged)